<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="description" contebt="namco's blog | python"><meta name="viewport" content="width=device-width, initial-scale=1"><title>namco's blog</title><link rel="short icon" href="/favicon.ico"><link rel="stylesheet" href="/./css/style.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,600|Roboto Mono"></head><body><div id="main"><header><a href="/." class="logo">namco's blog</a><ul class="nav"><li class="nav-link"><a href="/" target="_self">Home</a></li><li class="nav-link"><a href="/archives/" target="_self">Archives</a></li><li class="nav-link"><a href="/tags/" target="_self">Tags</a></li><li class="nav-link"><a href="/about/" target="_self">About</a></li></ul></header><section id="container"><article class="post"><h1 class="post-title">如何优雅地通过字符串动态调用函数</h1><span class="post-time">Jun 12, 2016</span><div class="post-content"><p>前一段时间为公司的业务写了一个非常轻量级的监控平台，最近抽出空来整理一下思路。首先从一个小 trick 开始吧。</p>
<h2 id="scrapy-中的-item-pipeline"><a href="#scrapy-中的-item-pipeline" class="headerlink" title="scrapy 中的 item pipeline"></a>scrapy 中的 item pipeline</h2><p>我写的监控平台的 pipeline 机制主要模仿了 scrapy 中的 item pipeline。 在 scrapy 的配置文件中，pipeline 的配置表示方式是这样的：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ITEM_PIPELINES = &#123;</span><br><span class="line">    <span class="string">'myproject.pipelines.FirstPipeline'</span>: <span class="number">300</span>,</span><br><span class="line">    <span class="string">'myproject.pipelines.SecondPipeline'</span>: <span class="number">800</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>ITEM_PIPELINES</code>作为一个字典，<code>key</code>就是处理类的路径，<code>value</code>值的大小则代表了该 pipeline 的优先级。<br><a id="more"></a></p>
<p>我们的监控平台远没有 scrapy 这么复杂，因此就只需要一个列表，根据列表顺序依次执行函数就可以了。于是问题来了。(学挖掘机哪家强？)我们如何像 scrapy 一样通过字符串表示的路径来读取出相应的类或者函数呢？</p>
<h2 id="importlab-的使用"><a href="#importlab-的使用" class="headerlink" title="importlab 的使用"></a>importlab 的使用</h2><p>其实非常简单，我们只需要使用<code>importlib</code>来引入对应的包就可以了。如果需要返回具体的执行函数，就利用<code>getattr</code>。具体代码示例如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">import_attribute</span><span class="params">(name)</span>:</span></span><br><span class="line">    <span class="string">"""Return an attribute from a dotted path name (e.g. "path.to.func")."""</span></span><br><span class="line">    module_name, attribute = name.rsplit(<span class="string">'.'</span>, <span class="number">1</span>)</span><br><span class="line">    module = importlib.import_module(module_name)</span><br><span class="line">    <span class="keyword">return</span> getattr(module, attribute)</span><br><span class="line"></span><br><span class="line">func = import_attribute(<span class="string">'monitor_platform.src.pipelines.common_pipeline.send_mail'</span>)</span><br><span class="line">func()</span><br></pre></td></tr></table></figure></p>
<p>在主线程中，调用<code>import_attribute</code>，首先<code>.rsplit</code>将包名与属性名分离，然后通过<code>importlib.import_module</code>引入包，最后通过<code>getattr</code>获取到该属性，此时获取到的<code>func</code>就是我们希望执行的函数了。只要提供一个 pipeline 的列表，就可以依次引入，顺序执行。就是这么简单。</p>
</div></article><div class="tags"><a href="/tags/python/">python</a><a href="/tags/trick/">trick</a></div><div class="paginator"><a href="/2016-06-12-tips-about-flask-view-function.html" class="next"><span>Next</span><i class="fa fa-chevron-right"></i></a></div></section><footer><div class="copyright"><p>&copy;2015-2016<span class="heart"><i class="fa fa-heart"></i></span><a href="http://yoursite.com" class="author">namco</a></p></div><label id="back2top"><i class="fa fa-chevron-up"></i></label></footer></div></body><script src="/js/back2top.js"></script></html>