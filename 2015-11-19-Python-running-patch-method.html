<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="description" contebt="namco's blog | python"><meta name="viewport" content="width=device-width, initial-scale=1"><title>namco's blog</title><link rel="short icon" href="/favicon.ico"><link rel="stylesheet" href="/./css/style.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,600|Roboto Mono"></head><body><div id="main"><header><a href="/." class="logo">namco's blog</a><ul class="nav"><li class="nav-link"><a href="/" target="_self">Home</a></li><li class="nav-link"><a href="/archives/" target="_self">Archives</a></li><li class="nav-link"><a href="/tags/" target="_self">Tags</a></li><li class="nav-link"><a href="/about/" target="_self">About</a></li></ul></header><section id="container"><article class="post"><h1 class="post-title">Python 的运行时方法补丁技术</h1><span class="post-time">Jun 12, 2016</span><div class="post-content"><blockquote>
<p>本文由 伯乐在线 - Namco 翻译，赖信涛 校稿。未经许可，禁止转载！<br>英文出处：blog.tryolabs.com。欢迎加入翻译组。</p>
</blockquote>
<p>相信很多朋友在编程的时候都会想修改一下已经写好的程序行为代码，而最常见的方式就是通过子类来重写父类的一些不满足需求的方法。比如说下面这个例子。</p>
<a id="more"></a>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class Dog:</span><br><span class="line">    def bark(self):</span><br><span class="line">        print 'Woof!'</span><br><span class="line"></span><br><span class="line">class Husky(Dog):</span><br><span class="line">    def bark(self)</span><br><span class="line">        print 'Howl!'</span><br></pre></td></tr></table></figure>
<p>我们可以用上述方式来修改我们自己写的代码，但是我们应该怎么修改第三方代码呢？当然，我们也可以自己编写一个子类，调用子类的实例对象来实现修改，但是这样可能会引入其他一系列问题。所以我们得想个办法用我们自己的方法替换掉原来的对象方法，这就是本文接下来要介绍的“打补丁”的方式。</p>
<h2 id="给类打补丁"><a href="#给类打补丁" class="headerlink" title="给类打补丁"></a>给类打补丁</h2><p>如果我们想新增或是修改对象的方法的话，最简单的方式莫过于给类打个补丁了。结合上面的例子，如果我们想给我们自己的 Dog 类写一个新的 howl 方法的话，我们可以定义一个新的 howl 函数，像下面的代码一样把它添加到我们的类中：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">newbark</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">'Wrooof!'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">howl</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">'Howl!'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Replace an existing method</span></span><br><span class="line">Dog.bark = newbark</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add a new method</span></span><br><span class="line">Dog.howl = howl</span><br></pre></td></tr></table></figure>
<p>很简单吧？但是这里有几个问题需要我们注意。首先，被修改的类的所有实例中的方法都会被更新，所以更新后的方法不仅仅存在于新创建的对象中，之前创建的所有对象都会拥有更新之后的方法，除非只是新增而不是覆盖掉原来的方法。第二，你修改或者新增的方法应当是与对象绑定的，所以方法的第一个参数应当是被调用的对象（在这里就是类的实例self）。</p>
<h2 id="给项目打补丁"><a href="#给项目打补丁" class="headerlink" title="给项目打补丁"></a>给项目打补丁</h2><p>单个对象也可以在不影响这个类的其他实例的情况下打补丁。但是还是有点小技巧的哦！先让我们看看下面这个例子。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">herd</span><span class="params">(self, sheep)</span>:</span></span><br><span class="line">    self.run()</span><br><span class="line">    self.bark()</span><br><span class="line">    self.run()</span><br><span class="line"></span><br><span class="line">border_collie = Dog()</span><br><span class="line">border_collie.herd = herd</span><br></pre></td></tr></table></figure></p>
<p>然后我们再试试调用新定义的方法：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">border_collie.herd(sheep)</span><br><span class="line"></span><br><span class="line">TypeError: herd() takes exactly <span class="number">2</span> arguments (<span class="number">1</span> given)</span><br><span class="line">The problem <span class="keyword">with</span> the previous code <span class="keyword">is</span> that the herd <span class="keyword">is</span> <span class="keyword">not</span> a bound method, just take a look at the following code:</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> border_collie.herd</span><br><span class="line"></span><br><span class="line">&lt;function herd at <span class="number">0xf9c5f0</span>&gt;</span><br></pre></td></tr></table></figure></p>
<p>出错啦！引发错误的原因就是被调用的对象并没有作为第一个参数传给我们写的函数。当然我们可以自己把参数传进去，但是在这个替换类方法的场景下并不奏效。解决这个问题的正确方案是用 type 这个模块里的 MethodType 函数，我们可以看看下面的示例代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">import types</span><br><span class="line"></span><br><span class="line">border_collie = Dog()</span><br><span class="line">border_collie.herd  = types.MethodType(herd, border_collie)</span><br><span class="line"></span><br><span class="line">print border_collie.herd</span><br></pre></td></tr></table></figure></p>
<p>现在我们的方法已经和实例绑定了，大功告成！</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>运行中替换或者添加方法是非常有用的，比如说在单元测试中，有些负责和外界服务通信的函数就需要替换掉，方便测试。这个技巧不仅很常用，而且在你最终决定要修改代码之前还可以保持代码的可维护性，是一个非常重要的技巧。</p>
</div></article><div class="tags"><a href="/tags/Python/">Python</a><a href="/tags/翻译/">翻译</a></div><div class="paginator"><a href="/2015-11-21-realization-of-integer-object-of-python.html" class="prev"><i class="fa fa-chevron-left"></i><span> Prev</span></a></div></section><footer><div class="copyright"><p>&copy;2015-2016<span class="heart"><i class="fa fa-heart"></i></span><a href="http://yoursite.com" class="author">namco</a></p></div><label id="back2top"><i class="fa fa-chevron-up"></i></label></footer></div></body><script src="/js/back2top.js"></script></html>